<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" >
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  ><!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="FastAPI와 SQLAlchemy 환경에서 Database Test" />
<meta name="author" content="김 정배" />
<meta property="og:locale" content="ko_KR" />
<meta name="description" content="FIRST 원칙" />
<meta property="og:description" content="FIRST 원칙" />
<link rel="canonical" href="https://blog.by-softcorp.com/posts/fast-api-db-test/" />
<meta property="og:url" content="https://blog.by-softcorp.com/posts/fast-api-db-test/" />
<meta property="og:site_name" content="BY Soft Tech Insights" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-06-26T15:32:00+09:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="FastAPI와 SQLAlchemy 환경에서 Database Test" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"김 정배"},"dateModified":"2022-06-26T15:32:00+09:00","datePublished":"2022-06-26T15:32:00+09:00","description":"FIRST 원칙","headline":"FastAPI와 SQLAlchemy 환경에서 Database Test","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.by-softcorp.com/posts/fast-api-db-test/"},"url":"https://blog.by-softcorp.com/posts/fast-api-db-test/"}</script>
<!-- End Jekyll SEO tag -->


  <title>FastAPI와 SQLAlchemy 환경에서 Database Test | BY Soft Tech Insights
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="BY Soft Tech Insights">
<meta name="application-name" content="BY Soft Tech Insights">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">
  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  
    <!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener('change', () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }
          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();
      });
    } /* constructor() */

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    flipMode() {
      if (this.hasMode) {
        if (this.isSysDarkPrefer) {
          if (this.isLightMode) {
            this.clearMode();
          } else {
            this.setLight();
          }
        } else {
          if (this.isDarkMode) {
            this.clearMode();
          } else {
            this.setDark();
          }
        }
      } else {
        if (this.isSysDarkPrefer) {
          this.setLight();
        } else {
          this.setDark();
        }
      }

      this.notify();
    } /* flipMode() */
  } /* ModeToggle */

  const modeToggle = new ModeToggle();
</script>

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/commons/bi.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <h1 class="site-title">
      <a href="/">BY Soft Tech Insights</a>
    </h1>
    <p class="site-subtitle fst-italic mb-0">Building the Future with the Power of Code, Our Story Awaits You Here.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    
      <button type="button" class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
        <a
          href="https://github.com/BY-SoftCorp"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['dev','by-softcorp.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">
                Home
              </a>
            </span>

          
        
          
        
          
            
              <span>FastAPI와 SQLAlchemy 환경에서 Database Test</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->





<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  

  
  

  




<!-- return -->




<article class="px-1">
  <header>
    <h1 data-toc-skip>FastAPI와 SQLAlchemy 환경에서 Database Test</h1>

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1656225120"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Jun 26, 2022
</time>

      </span>

      <!-- lastmod date -->
      

      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                김 정배
                
              
            
          </em>
        </span>

        <!-- read time -->
        <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3276 words"
>
  <em>18 min</em> read</span>

      </div>
      <!-- .d-flex -->
    </div>
    <!-- .post-meta -->
  </header>

  <div class="content">
    <h2 id="first-원칙"><span class="me-2">FIRST 원칙</span><a href="#first-원칙" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>단위 테스트를 수행하는 데 있어 여러 가지 가이드가 있지만 일반적으로 적용하고 있는 FIRST 원칙은 다음과 같습니다.</p>

<ul>
  <li>Fast</li>
  <li>Independent</li>
  <li>Repeatable</li>
  <li>Self-Validating</li>
  <li>Timely</li>
</ul>

<p>하지만 22년 6월 기준 FastAPI와 SQLAlchemy에서 제공하는 공식문서상의 튜토리얼을 따라가면 2번째 항목인 Independent를 만족하지 못하는 현상이 발생합니다. 이는 매우 안타까운 상황이며, 많은 기술 블로그를 보아도 위와 같은 상황으로 고민하는 개발자들을 만나볼 수 있죠.
이 포스팅은 이런 문제에 대해 다른 Unit-Test lib에서와 같이 독립성을 보장하는 데이터베이스 환경을 구성하는 방향으로 잡아보았습니다.</p>

<h2 id="database-engine"><span class="me-2">Database Engine</span><a href="#database-engine" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>FastAPI에서 제공하는 공식 문서대로 테스트 환경에서 Database를 이용해야 할 때 <code class="language-plaintext highlighter-rouge">sqlite:///:memory:</code>와 같이 <code class="language-plaintext highlighter-rouge">SQLite</code>를 이용하라고 권고하고 있습니다.
이와 같은 방식은 대부분 문제가 발생하지 않지만, 실제 서비스가 sqlite로 구성되어있지 않다면 몇몇 field 등에서는 실제로 구성된 스키마와 다른 문제 때문에 완벽한 테스트를 보장할 수 없다는 문제가 있습니다.
Test가 성공적으로 수행되고 난 후의 코드는 실제상황에서 안정적인 동작을 보장해야 하는데 <code class="language-plaintext highlighter-rouge">MySQL</code>을 사용하는 우리 서비스에서 SQLite를 이용한 Database 테스트를 수행할 수는 없었습니다.
또한 실제 환경과 동일한 환경을 구성하기 위한다는 명분으로 아무리 개발 서버라고 하더라도 Test를 그곳에서 실행할 수는 없다는 판단과 Test의 Performance를 위해 로컬 환경에 MySQL 서버를 생성하는 쪽으로 방향을 잡고 Docker를 이용해 MySQL 서버를 띄워보았습니다.</p>

<pre><code class="language-commandline">docker run --platform linux/amd64 -p 3306:3306 --name test_db -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=test_db -e MYSQL_PASSWORD=password --restart=unless-stopped -d mysql
</code></pre>

<h2 id="test-환경변수-설정"><span class="me-2">Test 환경변수 설정</span><a href="#test-환경변수-설정" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Test가 동작하는 환경이라고 하더라도 기본적으로 실제 환경과 거의 동일한 환경에서 작동되어야 합니다.
하지만 Test 환경에서만 적용되어야 하는 환경변수에 대한 Mocking이 필요한데 pytest에서 제공해주는 <code class="language-plaintext highlighter-rouge">pytest.ini</code>를 통해 다음과 같이 Database의 환경변수 위주로 재구성하였습니다. 위 Section에서도 설명했듯이 실제 Database에서 테스트를 진행할 수는 없으니까 말이죠.</p>

<div class="language-ini highlighter-rouge"><div class="code-header">
        <span data-label-text="Ini"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nn">[pytest]</span>
<span class="py">env</span> <span class="p">=</span>
    <span class="py">APP_ENV</span><span class="p">=</span><span class="s">test</span>
    <span class="py">DATABASE_HOST</span><span class="p">=</span><span class="s">localhost</span>
    <span class="py">DATABASE_USER</span><span class="p">=</span><span class="s">root</span>
    <span class="py">DATABASE_PASSWORD</span><span class="p">=</span><span class="s">password</span>
    <span class="py">DATABASE_NAME</span><span class="p">=</span><span class="s">test_db</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="database-engine-생성"><span class="me-2">Database Engine 생성</span><a href="#database-engine-생성" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>아이메디신 에서는 Database 접근에 대해서 <code class="language-plaintext highlighter-rouge">SQLAlchemy</code>라는 객체 형식으로 관리하고 있습니다. SQLAlchemy는 Python 환경에서 ORM을 제공해주는 라이브러리로, 상당히 많은 Python 기반의 프로젝트에서 사용하고 있을 정도로 범용성이 높다고 볼 수 있습니다. FastAPI의 공식 문서에서도 SQLAlchemy를 다루고 있기도 하죠.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Settings</span><span class="p">(</span><span class="n">BaseSettings</span><span class="p">):</span>

    <span class="p">...</span>

    <span class="o">@</span><span class="nb">property</span>
    <span class="k">def</span> <span class="nf">database_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s">'mysql+pymysql://</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">DATABASE_USER</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">DATABASE_PASSWORD</span><span class="si">}</span><span class="s">@'</span> \
               <span class="sa">f</span><span class="s">'</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">DATABASE_HOST</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">DATABASE_PORT</span><span class="si">}</span><span class="s">/</span><span class="si">{</span><span class="bp">self</span><span class="p">.</span><span class="n">DATABASE_NAME</span><span class="si">}</span><span class="s">?charset=utf8mb4'</span>

<span class="p">...</span>

<span class="k">class</span> <span class="nc">SQLAlchemy</span><span class="p">:</span>
    <span class="o">@</span><span class="nb">classmethod</span>
    <span class="k">def</span> <span class="nf">create_engine</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">setting_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">DATABASE_URL</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">database_url</span><span class="p">,</span>
            <span class="n">DATABASE_POOL_RECYCLE</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">DATABASE_POOL_RECYCLE</span><span class="p">,</span>
            <span class="n">DATABASE_ECHO</span><span class="o">=</span><span class="n">settings</span><span class="p">.</span><span class="n">DATABASE_ECHO</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="o">**</span><span class="n">setting_dict</span><span class="p">)</span>

    <span class="p">...</span>

<span class="p">...</span>

<span class="n">database</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">.</span><span class="n">create_engine</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Settings 객체를 보면 database_url을 조합, 리턴 해주는 property에서 <code class="language-plaintext highlighter-rouge">DATABASE_HOST</code>, <code class="language-plaintext highlighter-rouge">DATABASE_USER</code>… 등의 환경변수가 있는데, 만약 구동되는 환경이 Test 환경이라면 앞서 pytest.ini에서 설정해준 환경변수가 적용되어 local.database를 바라보게 될 것입니다.</p>

<h2 id="conftestpy"><span class="me-2">conftest.py</span><a href="#conftestpy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>pytest에서는 테스트 환경에 필요한 fixture, plugin, module 등을 관리하기 위해 <code class="language-plaintext highlighter-rouge">conftest.py</code>라는 파일을 사용할 것을 권하고 있습니다. 이는 단위테스트가 동작할 때 필요한 <code class="language-plaintext highlighter-rouge">given</code>을 미리 정의 해놓은 파일로, 일종의 <code class="language-plaintext highlighter-rouge">setUp</code> 함수와 비슷하지만 동일하지는 않죠.
또한 모든 단위테스트에서 단 하나의 session을 호출해야 테스트가 종료되었을 때 후속 작업을 일괄되게 처리할 수 있다는 점과 한 번의 단위테스트 내에서 몇 단계에 걸쳐 fixture를 호출해도 멱등성을 보장한다는 특징은 conftest를 사용해야 하는 이유이기도 하죠.</p>

<p>이제 conftest에 Test 용 Database 세션을 관리하도록 해보겠습니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">app.app_core.databases.conn</span> <span class="kn">import</span> <span class="n">database</span>


<span class="o">@</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s">'session'</span><span class="p">,</span> <span class="n">autouse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">db</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="kn">import</span> <span class="n">create_database</span><span class="p">,</span> <span class="n">database_exists</span><span class="p">,</span> <span class="n">drop_database</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">database</span><span class="p">.</span><span class="n">engine</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">'engine'</span><span class="p">:</span> <span class="n">engine</span><span class="p">,</span>
        <span class="s">'session'</span><span class="p">:</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">autocommit</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="n">url</span><span class="p">):</span>
        <span class="n">drop_database</span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>

    <span class="n">create_database</span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">alembic.config</span> <span class="kn">import</span> <span class="n">Config</span> <span class="k">as</span> <span class="n">AlembicConfig</span>
        <span class="kn">from</span> <span class="nn">alembic.command</span> <span class="kn">import</span> <span class="n">upgrade</span> <span class="k">as</span> <span class="n">alembic_upgrade</span><span class="p">,</span> <span class="n">downgrade</span> <span class="k">as</span> <span class="n">alembic_downgrade</span>
        <span class="kn">from</span> <span class="nn">app.app_core.settings</span> <span class="kn">import</span> <span class="n">settings</span>

        <span class="n">alembic_config</span> <span class="o">=</span> <span class="n">AlembicConfig</span><span class="p">()</span>
        <span class="n">alembic_config</span><span class="p">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s">'sqlalchemy.url'</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="n">database_url</span><span class="p">)</span>
        <span class="n">alembic_config</span><span class="p">.</span><span class="n">set_main_option</span><span class="p">(</span><span class="s">'script_location'</span><span class="p">,</span> <span class="s">'revision'</span><span class="p">)</span>
        <span class="n">alembic_upgrade</span><span class="p">(</span><span class="n">alembic_config</span><span class="p">,</span> <span class="s">'head'</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">_db</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">engine</span><span class="p">.</span><span class="n">dispose</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">fixture</code>에 제공되는 매개변수 중 <code class="language-plaintext highlighter-rouge">scope='session'</code>을 통해 해당 fixture가 테스트가 유지되는 동안 같은 인스턴스를 반환하도록 설정하였습니다. 이는 테스트 건당 데이터베이스를 생성하는 건 테스트의 성능 저하와도 밀접한 연관이 있기 때문입니다. 또한 <code class="language-plaintext highlighter-rouge">autouse=True</code> 옵션을 주어 명시적으로 <code class="language-plaintext highlighter-rouge">db</code>라는 fixture를 호출하지 않아도 데이터베이스가 구성될 수 있도록 처리하였습니다.
이제 db 인스턴스가 필요한 어느 곳에서든 <code class="language-plaintext highlighter-rouge">def test_some(db):</code>와 같은 방식으로 database에 접근할 수 있습니다.</p>

<p>하지만 대부분의 코드에서는 database 객체에 직접 접근 하는 경우보단 하나의 session에 접근하는 게 일반적입니다. 따라서 session 객체 역시 fixture로 관리해야 할 필요성을 느낍니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="o">@</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">engine</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">'engine'</span><span class="p">]</span>
    <span class="n">connection</span> <span class="o">=</span> <span class="n">engine</span><span class="p">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">connection</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">engine</span>
    <span class="n">transaction</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>


<span class="o">@</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="n">db</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Session</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="s">'session'</span><span class="p">]()</span>
    <span class="n">session</span><span class="p">.</span><span class="n">begin_nested</span><span class="p">()</span>
    <span class="k">yield</span> <span class="n">session</span>
    <span class="n">session</span><span class="p">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="n">session</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>현재까지 아이메디신의 FastAPI 프로젝트는 <code class="language-plaintext highlighter-rouge">engine</code>을 직접 제어하지는 않지만, 추후 필요할지도 모른다는 생각에 <code class="language-plaintext highlighter-rouge">session</code>을 만들면서 함께 만들어 보았습니다.
단위 테스트 내에서 반드시 conftest에 정의된 session fixture를 사용할 필요는 없지만, 앞서 설명한 것과 같이 테스트가 종료된 후 다른 테스트에 영향을 주지 않기 위해서 처리하는 <code class="language-plaintext highlighter-rouge">session.rollback()</code> 부분이 정상적으로 동작하기 위해선 session fixture를 사용할 것을 권합니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="c1"># 호출할 때마다 다른 인스턴스 생성
# session.commit(), session.close() 처리가 완료되기 전에 다른 session에서 접근 시
# 값이 반영되어 있지 않은 문제가 있음
# 또한 fixture에서 사용한 rollback() 처리가 동작하지 않음
</span><span class="k">def</span> <span class="nf">test_some</span><span class="p">():</span>
<span class="n">session</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">database</span><span class="p">.</span><span class="n">session</span><span class="p">())</span>
<span class="p">...</span>
<span class="c1"># 호출할 때마다 같은 인스턴스 생성
# flush() 처리만 되어있어도 데이터베이스에 값이 반영된 것처럼 보임
# 가장 중요한 rollback() 처리 한 번으로 다른 테스트 코드에 영향을 주지 않음
</span><span class="k">def</span> <span class="nf">test_some</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="dependency_overrides"><span class="me-2">dependency_overrides</span><a href="#dependency_overrides" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>FastAPI에서는 router 호출 시 <code class="language-plaintext highlighter-rouge">Depends</code>를 이용해 여러 곳에서 같은 함수를 호출하더라도 단 하나의 인스턴스를 이용할 수 있는 방식을 제공합니다. 일종의 Singleton 패턴과도 같은 방식이죠. 그리고 테스트 환경에서 이 의존성을 Mocking 할 수 있는 방법을 <code class="language-plaintext highlighter-rouge">dependency_overrides</code>라는 방식으로 제공해주고 있습니다.
dependency_overrides를 반드시 사용해야 하는 이유는 실제 동작 하는 코드인 router에서는 conftest의 fixture를 가져올 수 없기 때문입니다.
일반적으로 router 안에서 사용되는 database.session은 다음과 같은 방식으로 구현됩니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="o">@</span><span class="n">router</span><span class="p">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s">'/id'</span><span class="p">,</span>
    <span class="n">summary</span><span class="o">=</span><span class="s">'아이디 찾기'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">post_id</span><span class="p">(</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">database</span><span class="p">.</span><span class="n">session</span><span class="p">),</span>
<span class="p">):</span>
    <span class="p">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>만약 dependency_overrides를 정의해 놓지 않은 상황이라면 router를 호출할 때마다 다른 인스턴스의 session이 생성될 것이며, 다음과 같은 테스트 코드에서 그 동작을 신뢰성을 보장할 수 없습니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">test_some</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">):</span>
    <span class="n">customized_package</span> <span class="o">=</span> <span class="n">CustomizePackagePrice</span><span class="p">(...)</span>
    <span class="n">session</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">customized_package</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">PATH_PAYMENTS_V1_0</span> <span class="o">+</span> <span class="sa">f</span><span class="s">'/customize_price_package?packageId=</span><span class="si">{</span><span class="n">customized_package</span><span class="p">.</span><span class="nb">id</span><span class="si">}</span><span class="s">'</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">gen_admin_user</span>
    <span class="n">client</span><span class="p">.</span><span class="n">force_authenticate</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="p">...</span>


<span class="o">@</span><span class="n">router</span><span class="p">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s">'/customize_price_package'</span><span class="p">,</span>
    <span class="p">...</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">get_customize_package_price</span><span class="p">(</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">CustomizePackagePriceQuery</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(),</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">database</span><span class="p">.</span><span class="n">session</span><span class="p">),</span>
<span class="p">):</span>
    <span class="p">...</span>
    <span class="n">package_id</span> <span class="o">=</span> <span class="n">query</span><span class="p">.</span><span class="n">package_id</span>
    <span class="n">packages</span> <span class="o">=</span> <span class="n">list_customize_package_price</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">package_id</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
    <span class="c1"># dependency_overrides설정이 되어있지 않다면 다른 인스턴스의 session으로 인해 not found 발생
</span>    <span class="k">return</span> <span class="n">paginate</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>따라서 단위 테스트 실행 시 반드시 dependency_overrides를 구현해 주어야 동작의 신뢰도를 높일 수 있으며 FastAPI에서 제공하는 공식 문서상 구현 방법은 다음과 같습니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">override_get_db</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">TestingSessionLocal</span><span class="p">()</span>
        <span class="k">yield</span> <span class="n">db</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">db</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">app</span><span class="p">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">get_db</span><span class="p">]</span> <span class="o">=</span> <span class="n">override_get_db</span>
</pre></td></tr></tbody></table></code></div></div>

<p>하지만 이 방식대로 구현하게 되면 단위 테스트 내에서 사용하는 session과 router에서 사용되는 session이 다른 인스턴스를 사용하게 되는 문제가 있습니다. 위에서 지적한 동일한 인스턴스에 대한 접근이 위배 되는 상황이 발생하며, 무엇보다 한 번의 테스트가 끝난 후 그와 관련된 데이터의 rollback 처리가 수월하지 않다는 문제가 있죠.
이 문제를 해결하기 위해선 이전에 구성한 fixture를 dependency injection 해주어야 하는데 이런 방식을 구상해 보았습니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">app</span><span class="p">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">engine</span><span class="p">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="n">session</span>
</pre></td></tr></tbody></table></code></div></div>

<p>위 코드가 잘 동작한다면 훌륭하겠지만, 아주 커다란 문제가 있습니다. 바로 session이라는 fixture는 db라는 다른 fixture를 매개변수로 받고 있다는 점과 fixture는 일종의 @property라는 점이죠. 아마도 당신이 위 코드를 실행하면 다음과 같은 오류를 만나게 될 것입니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="s">'&lt;sqlalchemy.orm.session.Session object at 0x1145520d0&gt; is not a callable object'</span>
</pre></td></tr></tbody></table></code></div></div>

<p>난관에 부딪힌 상황이었지만, 다행히도 <code class="language-plaintext highlighter-rouge">lambda</code> 키워드를 사용해 생각보다는 간단하게 문제를 해결할 수 있었습니다. 또한 아이메디신에서 현재까지 개발된 테스트 코드는 Depends를 이용하기 위해선 TestClient를 이용해 router를 호출하는 때 외에는 없으므로 dependency_overrides를 TestClient를 호출하는 fixture에서 설정해주도록 구성해보았습니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="o">@</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">client</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="c1"># lambda식을 이용해 function 형태로 inject
</span>    <span class="n">app</span><span class="p">.</span><span class="n">dependency_overrides</span><span class="p">[</span><span class="n">engine</span><span class="p">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">session</span>
    <span class="kn">from</span> <span class="nn">tests.test_routes</span> <span class="kn">import</span> <span class="n">get_client</span>
    <span class="k">return</span> <span class="n">get_client</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></div></div>

<p>위와 같은 구성으로 test 코드와 router에서 하나의 인스턴스 session을 사용하게 되어 router 테스트에서 완벽한 테스트 결과를 기대할 수 있게 되었습니다.</p>

<h2 id="환경-구성의-누락-방지"><span class="me-2">환경 구성의 누락 방지</span><a href="#환경-구성의-누락-방지" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>만약 당신이 구현하고 있는 프로젝트의 데이터베이스에 대한 접근제어가 strict 하지 않은 상황이고, 프로젝트를 다른 환경에서 clone 하여 작업을 하려던 중 pytest.ini를 구성하는 걸 잊은 상태라면 pytest 명령어를 입력하는 순간</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">if</span> <span class="n">database_exists</span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="n">url</span><span class="p">):</span>
    <span class="n">drop_database</span><span class="p">(</span><span class="n">engine</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>설정에 따라 실제 데이터 베이스에 모든 테이블이 삭제되는 현상이 발생할 것입니다. 이는 실제 서비스가 중단될지도 모르는 매우 위험한 상황을 내포하고 있죠.</p>

<p>제가 생각하는 이상적인 접근제어라면 database 인스턴스는 VPC 안에서 private 공간에 위치해야 하고, 해당 프로젝트를 개발하고 있는 Engineer라고 하더라도 직접적으로 데이터베이스에 접근할 수 있어서는 안 됩니다.
하지만 여러 가지 상황으로 위와 같은 환경 구성이 어려운 경우 다음과 같은 검증 식을 conftest.py 최상단에 추가 함으로써, 데이터베이스를 삭제하는 실수를 방지할 수 있을것입니다.</p>

<div class="language-python highlighter-rouge"><div class="code-header">
        <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">assert</span> <span class="n">settings</span><span class="p">.</span><span class="n">APP_ENV</span> <span class="o">==</span> <span class="s">'test'</span><span class="p">,</span> <span class="s">'test 환경에서만 test 가능, `pytest.ini` 확인 필!'</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="마치며"><span class="me-2">마치며</span><a href="#마치며" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>단위테스트는 프로젝트를 개발해 나감에 있어 아주 기본적이지만 매우 중요한 절차이기 때문에 다른 포스팅 보단 조금 더 심도 있게 다루어 보았습니다. 아마도 다른 주제로 또다시 단위 테스트에 대해서 포스팅을 작성할 것 같다는 생각이 들기도 하네요.
또 다른 단위 테스트 주제로 만나 뵙기를 희망합니다 :)</p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/python/">python</a>,
          <a href="/categories/backend/">backend</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/fastapi/"
            class="post-tag no-text-decoration"
          >fastapi</a>
        
          <a
            href="/tags/sqlalchemy/"
            class="post-tag no-text-decoration"
          >sqlalchemy</a>
        
          <a
            href="/tags/unittest/"
            class="post-tag no-text-decoration"
          >unittest</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=FastAPI%EC%99%80%20SQLAlchemy%20%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%20Database%20Test%20-%20BY%20Soft%20Tech%20Insights&url=https%3A%2F%2Fblog.by-softcorp.com%2Fposts%2Ffast-api-db-test%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=FastAPI%EC%99%80%20SQLAlchemy%20%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%20Database%20Test%20-%20BY%20Soft%20Tech%20Insights&u=https%3A%2F%2Fblog.by-softcorp.com%2Fposts%2Ffast-api-db-test%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Fblog.by-softcorp.com%2Fposts%2Ffast-api-db-test%2F&text=FastAPI%EC%99%80%20SQLAlchemy%20%ED%99%98%EA%B2%BD%EC%97%90%EC%84%9C%20Database%20Test%20-%20BY%20Soft%20Tech%20Insights" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/react-unit-test/">ViewModel과 Model 유닛 테스트하기</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/reuse-viewmodel/">공통 기능을 가진 ViewModel 만들어 재사용하기</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/apply-mvvm-design/">신입 프론트엔드 개발자의 MVVM 패턴 적용기</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/fast-api-db-test/">FastAPI와 SQLAlchemy 환경에서 Database Test</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/annotated-enum/">Python 열거형과 SQLAlchemy</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/design-pattern/">design-pattern</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastapi/">fastapi</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/mvvm/">mvvm</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/sqlalchemy/">sqlalchemy</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/enum/">enum</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pydantic/">pydantic</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/unit-test/">unit-test</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/unittest/">unittest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/validate/">validate</a>
      
    </div>
  </section>


            </div>

            
              
              



  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->














  

  
    
  

  

  

  

  

  

  

  

  

  

  

  











  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/fast-api-validator/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1650844800"
  data-df="ll"
  
>
  Apr 25, 2022
</time>

              <h4 class="pt-0 my-2">FastAPI 유효성 검사</h4>
              <div class="text-muted">
                <p>
                  





                  Request Body Validate

API 요청을 받으면 최소한으로 수행해야 하는 유효성 검사가 있습니다. 보안의 가장 기본인 SQL Injection 공격 이외에도 전달받은 데이터가 필요로 하는 최소한의 규칙 등이 있습니다.
password를 예로 들자면 대소문자, 숫자, 특수문자를 포함해 최소 8에서 최대 20자리까지의 텍스트를 만족한다던가 ...
                </p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/annotated-enum/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1652572800"
  data-df="ll"
  
>
  May 15, 2022
</time>

              <h4 class="pt-0 my-2">Python 열거형과 SQLAlchemy</h4>
              <div class="text-muted">
                <p>
                  





                  Python의 Enum Type

기본적으로 Python의 열거형은 여러 이름을 같은 값에 대해 별칭으로 사용합니다.
예를 들면 열거형의 멤버에 동일한 값을 가진 A와 B가 정의되어 있다면 B는 A의 별칭입니다.

class Shape(Enum):
    SQUARE = 2
    DIAMOND = 1
    CIRCLE = 3
    ALIAS_FO...
                </p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/annotated-enum/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Python 열거형과 SQLAlchemy</p>
    </a>
  

  
    <a
      href="/posts/apply-mvvm-design/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>신입 프론트엔드 개발자의 MVVM 패턴 적용기</p>
    </a>
  
</nav>

            
              
              <!--  The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>
    ©
    <time>2024</time>
    <a href="https://github.com/BY-SoftCorp">BY-Soft</a>.
    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >Some rights reserved.</span>
    
  </p>

  <p>
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/design-pattern/">design-pattern</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/fastapi/">fastapi</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/mvvm/">mvvm</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/sqlalchemy/">sqlalchemy</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/enum/">enum</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pydantic/">pydantic</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/unit-test/">unit-test</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/unittest/">unittest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/validate/">validate</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->

    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script>






<script defer src="/assets/js/dist/post.min.js"></script>






    

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>
  /* Note: dependent library will be loaded in `js-selector.html` */
  SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5"></p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

